# ä¸»ä»“åº“åŒæ­¥ç­–ç•¥

æœ¬æ–‡æ¡£è¯´æ˜å¦‚ä½•å°† SaaS åˆ†æ”¯ä¸ä¸Šæ¸¸ OpenClaw ä¸»ä»“åº“ä¿æŒåŒæ­¥ï¼Œç¡®ä¿èƒ½å¤ŸåŠæ—¶è·å–ä¸Šæ¸¸æ›´æ–°ï¼ŒåŒæ—¶ä¿æŠ¤å¤šç§Ÿæˆ·æ‰©å±•ä»£ç ä¸è¢«è¦†ç›–ã€‚

## è®¾è®¡åŸåˆ™

å¤šç§Ÿæˆ· SaaS æ‰©å±•é‡‡ç”¨ **çº¯æ‰©å±•** è®¾è®¡ï¼š

1. **åªæ–°å¢ï¼Œä¸ä¿®æ”¹** - æ‰€æœ‰å¤šç§Ÿæˆ·åŠŸèƒ½é€šè¿‡æ–°å¢æ–‡ä»¶å®ç°
2. **ç‹¬ç«‹ç›®å½•** - æ‰©å±•ä»£ç æ”¾åœ¨ä¸“ç”¨ç›®å½•/æ–‡ä»¶ä¸­
3. **é…ç½®å¼€å…³** - é€šè¿‡ `multiTenant.enabled` æ§åˆ¶ï¼Œé»˜è®¤å…³é—­

è¿™ç§è®¾è®¡ç¡®ä¿äº†ä¸ä¸Šæ¸¸ä»“åº“çš„**é›¶å†²çªåˆå¹¶**ã€‚

## ä»“åº“é…ç½®

### æ·»åŠ ä¸Šæ¸¸è¿œç¨‹ä»“åº“

```bash
# æ·»åŠ ä¸Šæ¸¸ä»“åº“
git remote add upstream https://github.com/openclaw/openclaw.git

# éªŒè¯è¿œç¨‹ä»“åº“
git remote -v
# origin    git@github.com:your-org/openclaw.git (fetch)
# origin    git@github.com:your-org/openclaw.git (push)
# upstream  https://github.com/openclaw/openclaw.git (fetch)
# upstream  https://github.com/openclaw/openclaw.git (push)
```

### åˆ†æ”¯ç­–ç•¥

| åˆ†æ”¯ | ç”¨é€” | æ¥æº |
|------|------|------|
| `main` | ä¸Šæ¸¸ä¸»åˆ†æ”¯é•œåƒ | upstream/main |
| `saas-bot` | SaaS å¼€å‘åˆ†æ”¯ | åŸºäº main + å¤šç§Ÿæˆ·æ‰©å±• |
| `saas-release` | SaaS å‘å¸ƒåˆ†æ”¯ | ç»è¿‡æµ‹è¯•çš„ saas-bot |

## åŒæ­¥æµç¨‹

### æ—¥å¸¸åŒæ­¥ (æ¨èæ¯å‘¨æ‰§è¡Œ)

```bash
# 1. ç¡®ä¿å·¥ä½œåŒºå¹²å‡€
git status
git stash  # å¦‚æœ‰æœªæäº¤æ›´æ”¹

# 2. åˆ‡æ¢åˆ° main åˆ†æ”¯å¹¶æ‹‰å–ä¸Šæ¸¸æ›´æ–°
git checkout main
git fetch upstream
git merge upstream/main --ff-only

# 3. æ¨é€åˆ° origin
git push origin main

# 4. å°†æ›´æ–°åˆå¹¶åˆ° saas-bot åˆ†æ”¯
git checkout saas-bot
git merge main

# 5. è§£å†³å†²çªï¼ˆå¦‚æœ‰ï¼‰ï¼Œè¿è¡Œæµ‹è¯•
pnpm install  # ä¾èµ–å¯èƒ½æœ‰æ›´æ–°
pnpm build
pnpm test

# 6. æ¨é€æ›´æ–°
git push origin saas-bot

# 7. æ¢å¤ä¹‹å‰çš„å·¥ä½œ
git stash pop  # å¦‚æœä¹‹å‰æœ‰ stash
```

### å¿«é€ŸåŒæ­¥è„šæœ¬

åˆ›å»º `scripts/sync-upstream.sh`ï¼š

```bash
#!/bin/bash
set -e

echo "ğŸ”„ Syncing with upstream..."

# ä¿å­˜å½“å‰åˆ†æ”¯
CURRENT_BRANCH=$(git branch --show-current)

# æ£€æŸ¥å·¥ä½œåŒº
if ! git diff-index --quiet HEAD --; then
    echo "âŒ Working directory not clean. Please commit or stash changes."
    exit 1
fi

# åŒæ­¥ main
echo "ğŸ“¥ Fetching upstream..."
git fetch upstream

echo "ğŸ”€ Updating main branch..."
git checkout main
git merge upstream/main --ff-only
git push origin main

# åŒæ­¥ saas-bot
echo "ğŸ”€ Merging into saas-bot..."
git checkout saas-bot
git merge main -m "chore: sync with upstream main"

# éªŒè¯æ„å»º
echo "ğŸ”¨ Building..."
pnpm install
pnpm build

echo "âœ… Sync complete!"
echo "ğŸ“‹ Please run tests before pushing: pnpm test"

# è¿”å›åŸåˆ†æ”¯
git checkout "$CURRENT_BRANCH"
```

## å†²çªå¤„ç†

### é¢„æœŸæ— å†²çªçš„æ–‡ä»¶

ç”±äºé‡‡ç”¨çº¯æ‰©å±•è®¾è®¡ï¼Œä»¥ä¸‹æ–‡ä»¶**ä¸åº”è¯¥**äº§ç”Ÿå†²çªï¼š

```
src/config/types.multi-tenant.ts     # æ–°å¢æ–‡ä»¶
src/config/multi-tenant.ts           # æ–°å¢æ–‡ä»¶
src/agents/workspace-resolver.ts     # æ–°å¢æ–‡ä»¶
src/agents/multi-tenant-context.ts   # æ–°å¢æ–‡ä»¶
src/agents/pi-embedded-runner/run-multi-tenant.ts  # æ–°å¢æ–‡ä»¶
src/gateway/multi-tenant/*           # æ–°å¢ç›®å½•
src/commands/multi-tenant.ts         # æ–°å¢æ–‡ä»¶
å¼€å‘æ–‡æ¡£/*                            # æ–°å¢ç›®å½•
```

### å¯èƒ½å†²çªçš„æ–‡ä»¶

ä»¥ä¸‹æ–‡ä»¶å¯èƒ½å› ä¸Šæ¸¸æ›´æ–°è€Œéœ€è¦å…³æ³¨ï¼š

| æ–‡ä»¶ | å†²çªåŸå›  | å¤„ç†ç­–ç•¥ |
|------|----------|----------|
| `package.json` | ä¾èµ–ç‰ˆæœ¬æ›´æ–° | ä¿ç•™ä¸Šæ¸¸ç‰ˆæœ¬ï¼Œæ£€æŸ¥å…¼å®¹æ€§ |
| `tsconfig.json` | ç¼–è¯‘é…ç½®å˜æ›´ | é€šå¸¸æ¥å—ä¸Šæ¸¸æ›´æ”¹ |
| `src/config/types.ts` | ç±»å‹å¯¼å‡º | ç¡®ä¿ multi-tenant å¯¼å‡ºä¿ç•™ |

### å†²çªè§£å†³ç¤ºä¾‹

**package.json å†²çªï¼š**

```bash
# æŸ¥çœ‹å†²çª
git diff package.json

# é€šå¸¸æ¥å—ä¸Šæ¸¸çš„ä¾èµ–ç‰ˆæœ¬
git checkout --theirs package.json

# å¦‚æœæˆ‘ä»¬æ·»åŠ äº†æ–°ä¾èµ–ï¼Œæ‰‹åŠ¨æ·»åŠ å›æ¥
# ç¼–è¾‘ package.json æ·»åŠ æˆ‘ä»¬çš„ä¾èµ–

# é‡æ–°å®‰è£…å¹¶æµ‹è¯•
pnpm install
pnpm build
pnpm test

# æ ‡è®°è§£å†³
git add package.json
```

**src/config/types.ts å†²çªï¼š**

```bash
# ç¡®ä¿æˆ‘ä»¬çš„å¯¼å‡ºè¡Œä¿ç•™
# è¿™è¡Œåº”è¯¥åœ¨æ–‡ä»¶æœ«å°¾ï¼š
# export * from "./types.multi-tenant.js";

# åˆå¹¶åéªŒè¯
grep "types.multi-tenant" src/config/types.ts
```

## ç‰ˆæœ¬ç®¡ç†

### ç‰ˆæœ¬å·ç­–ç•¥

SaaS ç‰ˆæœ¬å·æ ¼å¼ï¼š`{upstream_version}-saas.{saas_version}`

ä¾‹å¦‚ï¼š
- ä¸Šæ¸¸ç‰ˆæœ¬ï¼š`2026.1.29`
- SaaS ç‰ˆæœ¬ï¼š`2026.1.29-saas.1`

### æ›´æ–°ç‰ˆæœ¬å·

```bash
# åŒæ­¥åæ›´æ–°ç‰ˆæœ¬
npm version prerelease --preid=saas
# æˆ–æ‰‹åŠ¨ç¼–è¾‘ package.json
```

## å‘å¸ƒæµç¨‹

### SaaS å‘å¸ƒæ£€æŸ¥æ¸…å•

1. **åŒæ­¥æ£€æŸ¥**
   - [ ] å·²åŒæ­¥æœ€æ–°ä¸Šæ¸¸ä»£ç 
   - [ ] æ‰€æœ‰å†²çªå·²è§£å†³

2. **åŠŸèƒ½éªŒè¯**
   - [ ] å¤šç§Ÿæˆ·æ¨¡å¼æ­£å¸¸å·¥ä½œ
   - [ ] å•ç”¨æˆ·æ¨¡å¼ï¼ˆç¦ç”¨å¤šç§Ÿæˆ·ï¼‰æ­£å¸¸å·¥ä½œ
   - [ ] Cloud Backend é›†æˆæ­£å¸¸

3. **æµ‹è¯•é€šè¿‡**
   - [ ] `pnpm build` æˆåŠŸ
   - [ ] `pnpm test` å…¨éƒ¨é€šè¿‡
   - [ ] `pnpm lint` æ— é”™è¯¯

4. **æ–‡æ¡£æ›´æ–°**
   - [ ] CHANGELOG å·²æ›´æ–°
   - [ ] å¼€å‘æ–‡æ¡£å·²æ›´æ–°ï¼ˆå¦‚æœ‰å˜æ›´ï¼‰

### å‘å¸ƒå‘½ä»¤

```bash
# 1. ç¡®ä¿åœ¨ saas-bot åˆ†æ”¯
git checkout saas-bot

# 2. æœ€åä¸€æ¬¡åŒæ­¥
./scripts/sync-upstream.sh

# 3. è¿è¡Œå®Œæ•´æµ‹è¯•
pnpm test

# 4. åˆ›å»ºå‘å¸ƒæ ‡ç­¾
git tag -a v2026.1.29-saas.1 -m "Release v2026.1.29-saas.1"
git push origin v2026.1.29-saas.1

# 5. åˆå¹¶åˆ° saas-release
git checkout saas-release
git merge saas-bot
git push origin saas-release
```

## ä¸Šæ¸¸è´¡çŒ®

å¦‚æœå¼€å‘äº†å¯èƒ½å¯¹ä¸Šæ¸¸æœ‰ä»·å€¼çš„åŠŸèƒ½ï¼ˆéå¤šç§Ÿæˆ·ç‰¹å®šï¼‰ï¼š

### è´¡çŒ®æµç¨‹

1. **åœ¨ç‹¬ç«‹åˆ†æ”¯å¼€å‘**
   ```bash
   git checkout -b feature/xxx upstream/main
   ```

2. **ç¡®ä¿ä¸åŒ…å«å¤šç§Ÿæˆ·ä»£ç **
   ```bash
   # æ£€æŸ¥æ˜¯å¦æœ‰å¤šç§Ÿæˆ·ç›¸å…³æ–‡ä»¶
   git diff upstream/main --name-only | grep -i multi-tenant
   # åº”è¯¥æ²¡æœ‰è¾“å‡º
   ```

3. **æäº¤ PR åˆ°ä¸Šæ¸¸**
   ```bash
   git push origin feature/xxx
   # åœ¨ GitHub ä¸Šåˆ›å»º PR åˆ° upstream/main
   ```

4. **PR åˆå¹¶ååŒæ­¥å› SaaS åˆ†æ”¯**
   ```bash
   git checkout saas-bot
   ./scripts/sync-upstream.sh
   ```

## ç´§æ€¥ä¿®å¤

### ä¸Šæ¸¸ç´§æ€¥å®‰å…¨æ›´æ–°

```bash
# 1. ç«‹å³åŒæ­¥
git fetch upstream
git checkout main
git merge upstream/main --ff-only

# 2. å¿«é€Ÿåˆå¹¶åˆ° saas-bot
git checkout saas-bot
git merge main

# 3. å¿«é€ŸéªŒè¯æ ¸å¿ƒåŠŸèƒ½
pnpm build
pnpm test -- --grep "multi-tenant"

# 4. éƒ¨ç½²
git push origin saas-bot
```

### SaaS ç‰¹æœ‰é—®é¢˜ä¿®å¤

```bash
# ç›´æ¥åœ¨ saas-bot åˆ†æ”¯ä¿®å¤
git checkout saas-bot
# ... ä¿®å¤ä»£ç  ...
git commit -m "fix: xxx"
git push origin saas-bot
```

## è‡ªåŠ¨åŒ–å»ºè®®

### GitHub Actions é…ç½®

åˆ›å»º `.github/workflows/sync-upstream.yml`ï¼š

```yaml
name: Sync Upstream

on:
  schedule:
    - cron: '0 0 * * 1'  # æ¯å‘¨ä¸€ UTC 0:00
  workflow_dispatch:      # æ‰‹åŠ¨è§¦å‘

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

      - name: Add upstream
        run: git remote add upstream https://github.com/openclaw/openclaw.git

      - name: Sync main
        run: |
          git fetch upstream
          git checkout main
          git merge upstream/main --ff-only
          git push origin main

      - name: Create sync PR
        run: |
          git checkout saas-bot
          git checkout -b sync/upstream-$(date +%Y%m%d)
          git merge main --no-edit || true
          git push origin sync/upstream-$(date +%Y%m%d)
          gh pr create --title "chore: sync upstream $(date +%Y-%m-%d)" \
            --body "Automated sync from upstream main" \
            --base saas-bot
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
```

## å¸¸è§é—®é¢˜

**Q: ä¸Šæ¸¸é‡æ„äº†æˆ‘ä»¬æ‰©å±•çš„æ¨¡å—æ€ä¹ˆåŠï¼Ÿ**

A: è¿™ç§æƒ…å†µå¾ˆå°‘å‘ç”Ÿï¼Œå¦‚æœå‘ç”Ÿï¼š
1. ç†è§£ä¸Šæ¸¸çš„é‡æ„æ„å›¾
2. ç›¸åº”è°ƒæ•´æˆ‘ä»¬çš„æ‰©å±•ä»£ç 
3. ç¡®ä¿æ‰©å±•ä»£ç ä»ç„¶æ˜¯"çº¯æ‰©å±•"

**Q: å¦‚ä½•ç¡®è®¤åŒæ­¥æ˜¯å¦æˆåŠŸï¼Ÿ**

A: è¿è¡Œä»¥ä¸‹æ£€æŸ¥ï¼š
```bash
# æ„å»ºé€šè¿‡
pnpm build

# æµ‹è¯•é€šè¿‡
pnpm test

# å¤šç§Ÿæˆ·åŠŸèƒ½æ­£å¸¸
pnpm openclaw multi-tenant stats
```

**Q: å¯ä»¥è·³è¿‡æŸäº›ä¸Šæ¸¸æ›´æ–°å—ï¼Ÿ**

A: ä¸å»ºè®®ã€‚ä¿æŒåŒæ­¥å¯ä»¥ï¼š
- è·å–å®‰å…¨ä¿®å¤
- ä¿æŒ API å…¼å®¹æ€§
- å‡å°‘æœªæ¥åˆå¹¶çš„å¤æ‚åº¦

## å‚è€ƒé“¾æ¥

- [Git æ–‡æ¡£ - ä½¿ç”¨è¿œç¨‹ä»“åº“](https://git-scm.com/book/zh/v2/Git-åŸºç¡€-è¿œç¨‹ä»“åº“çš„ä½¿ç”¨)
- [GitHub - Fork åŒæ­¥](https://docs.github.com/cn/pull-requests/collaborating-with-pull-requests/working-with-forks/syncing-a-fork)
