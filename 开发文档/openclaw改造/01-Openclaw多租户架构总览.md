# Openclaw 多租户 SaaS 化改造方案 - 总览

## 项目背景

基于开源项目 Openclaw（MIT License）进行二次开发，构建云端多租户 SaaS 服务。用户注册后获得专属的 LLM API 配置和 Gateway 认证 token，Openclaw 为每个用户启动独立的工作区，实现用户隔离。

## 核心目标

1. **多租户隔离**：单个 Gateway 进程服务多个用户，每个用户拥有独立的配置和工作区
2. **懒加载机制**：用户首次连接时才初始化配置，节省资源
3. **无侵入客户端**：保持现有 WebSocket 协议不变，客户端无需改动
4. **配置文件模式**：用户配置存储在独立目录，便于管理和备份
5. **模板化工作区**：共享模板 + 用户数据分离，节省存储空间

## 架构决策

### 部署模式：多租户进程隔离
- **理由**：成本效益好，资源利用率高

### 启动时机：懒加载模式
- **理由**：内存占用可控，适合大规模用户

### 连接方式：保持现有 WebSocket 协议
- **理由**：客户端无需改动，兼容性好

### 配置管理：配置文件模式
- **理由**：符合 Openclaw 现有架构，改动小

### 工作区管理：模板 + 用户数据分离
- **理由**：节省空间，便于统一更新模板

### 数据目录：独立数据目录 `/data/openclaw/`
- **理由**：便于备份、扩容、迁移

## 系统架构图

```
┌─────────────────────────────────────────────────────────────┐
│                      云端服务层                              │
│  ┌────────────────────────────────────────────────────────┐ │
│  │  Creator Flow Cloud Backend (FastAPI)                  │ │
│  │  - 用户注册/登录/订阅管理                               │ │
│  │  - 生成用户专属配置（API key, Gateway token）          │ │
│  │  - 积分计算/扣费                                        │ │
│  │  - 提供配置同步 API                                     │ │
│  └────────────────────────────────────────────────────────┘ │
│           ↓ HTTP API                                         │
└───────────┼──────────────────────────────────────────────────┘
            │
            ↓ 配置同步
┌───────────┼──────────────────────────────────────────────────┐
│           │         Openclaw Gateway 层（改造后）              │
│  ┌────────▼────────────────────────────────────────────────┐ │
│  │  Multi-Tenant Gateway Manager                          │ │
│  │  - 用户配置缓存（LRU）                                  │ │
│  │  - Token → UserId 映射                                 │ │
│  │  - 懒加载用户实例                                       │ │
│  └────────┬────────────────────────────────────────────────┘ │
│           │                                                   │
│  ┌────────▼────────────────────────────────────────────────┐ │
│  │  WebSocket Server (ws://0.0.0.0:18789)                 │ │
│  │  - 接受客户端连接                                       │ │
│  │  - 验证 auth.token                                     │ │
│  │  - 路由到对应用户实例                                   │ │
│  └────────┬────────────────────────────────────────────────┘ │
│           │                                                   │
│  ┌────────▼────────────────────────────────────────────────┐ │
│  │  User Instance Pool                                     │ │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐             │ │
│  │  │ User A   │  │ User B   │  │ User C   │             │ │
│  │  │ Config   │  │ Config   │  │ Config   │             │ │
│  │  │ Workspace│  │ Workspace│  │ Workspace│             │ │
│  │  │ Sessions │  │ Sessions │  │ Sessions │             │ │
│  │  └──────────┘  └──────────┘  └──────────┘             │ │
│  └─────────────────────────────────────────────────────────┘ │
└───────────┬──────────────────────────────────────────────────┘
            │
            ↓ LLM API 调用
┌───────────┼──────────────────────────────────────────────────┐
│           │         LLM 提供商层                              │
│  ┌────────▼────────────────────────────────────────────────┐ │
│  │  云端 LLM 代理（可选）                                   │ │
│  │  - 统一计费                                             │ │
│  │  - 流量控制                                             │ │
│  │  - 使用统计                                             │ │
│  └────────┬────────────────────────────────────────────────┘ │
│           │                                                   │
│  ┌────────▼────────────────────────────────────────────────┐ │
│  │  Anthropic / OpenAI / 其他 LLM                          │ │
│  └─────────────────────────────────────────────────────────┘ │
└───────────────────────────────────────────────────────────────┘

            ↑ WebSocket (wss://)
┌───────────┼──────────────────────────────────────────────────┐
│           │         客户端层（无需改动）                      │
│  ┌────────┴────────────────────────────────────────────────┐ │
│  │  用户客户端（WhatsApp/Telegram/Slack/Discord...）       │ │
│  │  配置：                                                  │ │
│  │  - Gateway URL: wss://your-domain.com:18789            │ │
│  │  - Auth Token: user_xxx_token                          │ │
│  └─────────────────────────────────────────────────────────┘ │
└───────────────────────────────────────────────────────────────┘
```

## 核心设计理念

1. **单 Gateway 多租户**：一个 Gateway 进程服务所有用户
2. **懒加载**：用户首次连接时才初始化配置和工作区
3. **配置隔离**：每个用户独立的配置目录和工作区
4. **无侵入客户端**：客户端协议保持不变，只需配置 URL 和 Token

## 技术栈

### Openclaw Gateway 层
- **语言**：TypeScript / Node.js 22+（Bun 也支持）
- **协议**：WebSocket (JSON frames)
- **配置**：JSON5 配置文件（通过 `createConfigIO()` 加载）
- **存储**：文件系统（配置、工作区、会话）
- **认证**：Token / Password / Tailscale / 设备配对

### 云端服务层
- **框架**：FastAPI + SQLAlchemy 2.0
- **数据库**：PostgreSQL + Redis
- **任务队列**：Celery
- **存储**：MinIO/S3

### 需要研究的核心文件
在开始改造前，必须深入理解以下现有文件：
- `src/gateway/auth.ts` - 现有认证逻辑（支持多种认证方式）
- `src/gateway/server/ws-connection/message-handler.ts` - WebSocket 连接处理
- `src/config/io.ts` - 配置加载（`createConfigIO()` 工厂模式）
- `src/agents/pi-embedded-runner/run.ts` - Agent 运行逻辑
- `src/agents/workspace.ts` - 工作区管理

## 文档结构

1. **01-Openclaw多租户架构总览.md**（本文档）- 整体架构和设计理念
2. **02-核心组件设计.md** - 目录结构、多租户管理器、工作区解析器
3. **03-核心流程设计.md** - 用户注册、认证、请求处理流程
4. **04-Openclaw改造清单.md** - 需要改造的文件和代码清单
5. **05-云端服务接入设计.md** - API 设计、数据库表结构、FastAPI 实现

## 下一步

请按顺序阅读后续文档，了解详细的实现方案。
